name: 'Slack Review Request Notify'
description: 'Send actions notification to Idobata'
inputs:
  channel-id:  # channel of input
    description: 'Slack Channel ID to post message'
    required: true
    default: ''
runs:
  using: "composite"
  steps:
    - name: ğŸ‘¤ Fix different username between GitHub <-> Slack
      run: |
        requestor=${{ github.triggering_actor }}
        requestee=${{ github.event.requested_reviewer.login }}

        echo "REQUESTOR=$requestor"          | \
          sed -e "s/rakuda-san-desu/rakuda/" | \
          sed -e "s/Yuppymam/yuppy/" >> $GITHUB_ENV
        echo "REQUESTEE=$requestee"          | \
          sed -e "s/rakuda-san-desu/rakuda/" | \
          sed -e "s/Yuppymam/yuppy/" >> $GITHUB_ENV

    - name: â° Set timezone and check if business days
      env:
        TZ: 'Asia/Tokyo' # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æŒ‡å®š
      run: |
        # å–¶æ¥­æ™‚é–“å†…ï¼ˆå¹³æ—¥ã®10æ™‚ã€œ18æ™‚ï¼‰ã§ã‚ã‚Œã°å³æ—¥é€šçŸ¥
        # æœˆæ›œ = 1ã€é‡‘æ›œ = 5
        echo "CURRENT_TIME=$(date +'%H')" >> $GITHUB_ENV
        echo "CURRENT_WEEK=$(date +'%w')" >> $GITHUB_ENV
        if [ "$CURRENT_TIME" -ge "10" ] && [ "$CURRENT_TIME" -le "18" ] && \
           [ "$CURRENT_WEEK" -ge "1"  ] && [ "$CURRENT_WEEK" -le "5"  ] ; then
           echo "IS_BUSINESS_TIME=true"  >> $GITHUB_ENV
        else
           echo "IS_BUSINESS_TIME=false" >> $GITHUB_ENV
        fi

    - name: ğŸ“ Compose prefix message to mention in Slack
      run: |
        # å–¶æ¥­æ™‚é–“å†…ãªã‚‰å³æ™‚é€šçŸ¥ã€æ™‚é–“å¤–ãªã‚‰ç¿Œå–¶æ¥­æ—¥ã«é€šçŸ¥
        if [ "${{ env.IS_BUSINESS_TIME }}" = "true" ]; then
          mention="<@${{ env.REQUESTEE }}>"
        else
          mention="<@tasslab> memo ${{ env.REQUESTEE }}"
        fi
        echo "SLACK_POST_MENTION=$mention" >> $GITHUB_ENV

    - name: ğŸ”” Review Request Notify
      uses: slackapi/slack-github-action@v1.23.0
      # cf. https://github.com/slackapi/slack-github-action
      id: slack
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      with:
        channel-id: ${{ inputs.channel-id }}
        slack-message: |
          ${{ env.SLACK_POST_MENTION }} :${{ env.REQUESTOR }}: ${{ env.REQUESTOR }} ã•ã‚“ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ãŒæ¥ã¦ã‚‹ã‚ˆ (â—ËƒÌ¶á—œË‚Ì¶â—)ï¾‰
          > :github: <${{ github.event.pull_request.html_url || github.event.head_commit.url }}|`${{ github.repository }}#${{ github.event.number }}`> - *<${{ github.event.pull_request.html_url || github.event.head_commit.url }}|${{ github.event.pull_request.title }}>*
