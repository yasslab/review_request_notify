name: 'Slack Review Request Notify'
description: 'Send actions notification to Idobata'
inputs:
  channel-id:  # channel of input
    description: 'Slack Channel ID to post message'
    required: true
    default: ''
  SLACK_BOT_TOKEN:  # channel of input
    description: 'Slack token to post message'
    required: true
    default: ''
runs:
  using: "composite"
  steps:
    - name: ğŸ‘¤ Fix different username between GitHub <-> Slack
      shell: bash
      run: |
        requestor=${{ github.triggering_actor }}
        requestee=${{ github.event.requested_reviewer.login || 'yasulab' }}
        # MEMO: 'requestee' can be null when triggered by workflow dispatch.

        echo "REQUESTOR=$requestor"          | \
          sed -e "s/rakuda-san-desu/rakuda/" | \
          sed -e "s/Yuppymam/yuppy/"         | \
          sed -e "s/dependabot\[bot\]/dependabot/" >> $GITHUB_ENV
        echo "REQUESTEE=$requestee"          | \
          sed -e "s/rakuda-san-desu/rakuda/" | \
          sed -e "s/Yuppymam/yuppy/"         | \
          sed -e "s/dependabot\[bot\]/dependabot/" >> $GITHUB_ENV

    - name: â° Set timezone and check if business days
      env:
        TZ: 'Asia/Tokyo' # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æŒ‡å®š
      shell: bash
      run: |
        # ç¥æ—¥ã§ã¯ãªãã€å–¶æ¥­æ™‚é–“å†…ï¼ˆå¹³æ—¥ã®10æ™‚ã€œ18æ™‚ï¼‰ã§ã‚ã‚Œã°å³æ—¥é€šçŸ¥
        current_time=$(date +'%H'); echo "CURRENT_TIME: $current_time"
        current_week=$(date +'%w'); echo "CURRENT_TIME: $current_week"
        is_holiday=$(
          ruby -r open-uri -e 'holidays = URI.open("https://yasslab.jp/holidays.json").read' \
               -r json -r date -e "puts JSON.parse(holidays).to_a.include? Date.today.to_s"
        )

        # ç¥æ—¥ã§ã‚ã‚Œã°æ¥­å‹™æ™‚é–“å¤–
        if [[ "$is_holiday" == "true"  ]] ; then
           echo "Current status: Japanese holidays"
           echo "IS_BUSINESS_TIME=false" >> $GITHUB_ENV

        # å¹³æ—¥ã®æ¥­å‹™æ™‚é–“å†…ã‹ã©ã†ã‹ã®åˆ¤å®šï¼ˆæœˆæ›œ = 1ã€é‡‘æ›œ = 5ï¼‰
        elif [ "$current_time" -ge "10" ] && [ "$current_time" -lt "18" ] && \
             [ "$current_week" -ge "1"  ] && [ "$current_week" -le "5"  ] ; then
           echo "Current status: Business hours"
           echo "IS_BUSINESS_TIME=true"  >> $GITHUB_ENV

        # ä¸Šè¨˜ä»¥å¤–ã§ã‚ã‚Œã°æ¥­å‹™æ™‚é–“å¤–ï¼ˆæ—©æœ/æ·±å¤œãªã©ï¼‰
        else
           echo "Current status: Not business hours"
           echo "IS_BUSINESS_TIME=false" >> $GITHUB_ENV
        fi

    - name: ğŸ“ Compose prefix message to mention in Slack
      shell: bash
      run: |
        # å–¶æ¥­æ™‚é–“å†…ãªã‚‰å³æ™‚é€šçŸ¥ã€æ™‚é–“å¤–ãªã‚‰ç¿Œå–¶æ¥­æ—¥ã«é€šçŸ¥
        if [ "${{ env.IS_BUSINESS_TIME }}" = "true" ]; then
          mention="<@${{ env.REQUESTEE }}>"
        else
          mention="<@tasslab> memo ${{ env.REQUESTEE }}"
        fi
        echo "SLACK_POST_MENTION=$mention" >> $GITHUB_ENV

    - name: ğŸ”” Review Request Notify
      uses: slackapi/slack-github-action@v1.23.0
      # cf. https://github.com/slackapi/slack-github-action
      id: slack
      env:
        SLACK_BOT_TOKEN: ${{ inputs.SLACK_BOT_TOKEN }}
      with:
        channel-id: ${{ inputs.channel-id }}
        slack-message: |
          ${{ env.SLACK_POST_MENTION }} :${{ env.REQUESTOR }}: ${{ env.REQUESTOR }} ã•ã‚“ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ãŒæ¥ã¦ã‚‹ã‚ˆ (â—ËƒÌ¶á—œË‚Ì¶â—)ï¾‰
          > :github: <${{ github.event.pull_request.html_url || github.event.head_commit.url }}|`${{ github.repository }}#${{ github.event.number }}`> - *<${{ github.event.pull_request.html_url || github.event.head_commit.url }}|${{ github.event.pull_request.title }}>*
